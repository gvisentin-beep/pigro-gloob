let chart = null;

function euro(x) {
  return new Intl.NumberFormat("it-IT", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 0,
  }).format(Number(x));
}

function pct(x) {
  if (x === null || x === undefined || isNaN(x)) return "â€”";
  return (x * 100).toFixed(1) + "%";
}

async function loadData() {
  const w_ls80 = Number(document.getElementById("w_ls80").value);
  const w_gold = Number(document.getElementById("w_gold").value);
  const capital = Number(document.getElementById("initial").value) || 10000;

  // Anti-cache totale (fondamentale su Render)
  const url = `/api/compute?w_ls80=${encodeURIComponent(w_ls80)}&w_gold=${encodeURIComponent(w_gold)}&capital=${encodeURIComponent(capital)}&t=${Date.now()}`;

  const res = await fetch(url, { cache: "no-store" });
  const data = await res.json();

  if (data.error) {
    console.error(data.error);
    alert(data.error);
    return;
  }

  // Aggiorna periodo
  if (data.dates && data.dates.length > 1) {
    document.getElementById("period").innerText =
      data.dates[0] + " â†’ " + data.dates[data.dates.length - 1];
  }

  // ðŸ”´ AGGIORNAMENTO TESTO CAGR E MAX DD (compatibile col tuo HTML attuale)
  if (data.metrics) {
    const m = data.metrics;

    const riga1 =
      `Portafoglio (LS80+Oro): CAGR ${pct(m.cagr_portfolio)} | Max DD ${pct(m.max_dd_portfolio)}`;
    const riga2 =
      `Solo LS80: CAGR ${pct(m.cagr_solo)} | Max DD ${pct(m.max_dd_solo)}`;

    // Trova automaticamente il blocco testo e lo aggiorna
    const blocks = document.querySelectorAll("div.card");
    blocks.forEach((block) => {
      if (block.innerText.includes("Portafoglio (LS80+Oro)")) {
        const lines = block.querySelectorAll("div, p, span, b");
        if (lines.length >= 2) {
          lines[0].innerText = riga1;
          lines[1].innerText = riga2;
        } else {
          block.innerHTML = `<b>${riga1}</b><br>${riga2}<br>Periodo: ${data.dates[0]} â†’ ${data.dates[data.dates.length - 1]}`;
        }
      }
    });
  }

  const ctx = document.getElementById("chart").getContext("2d");

  // Distrugge il grafico precedente (fondamentale)
  if (chart) {
    chart.destroy();
  }

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: data.dates,
      datasets: [
        {
          label: "Portafoglio (LS80+Oro)",
          data: data.portfolio,
          borderWidth: 2,
          tension: 0.15,
          pointRadius: 0,
        },
        {
          label: "Solo LS80",
          data: data.solo_ls80,
          borderWidth: 2,
          tension: 0.15,
          pointRadius: 0,
        },
      ],
    },
    options: {
      responsive: true,
      interaction: {
        mode: "index",
        intersect: false,
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function (context) {
              return context.dataset.label + ": " + euro(context.parsed.y);
            },
          },
        },
      },
      scales: {
        y: {
          ticks: {
            callback: function (value) {
              return euro(value);
            },
          },
        },
      },
    },
  });
}

// ðŸ”µ Collegamento SOLIDO al bottone Aggiorna
function init() {
  loadData();

  const btn = document.querySelector("button");
  if (btn) {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      loadData();
    });
  }
}

window.addEventListener("DOMContentLoaded", init);
